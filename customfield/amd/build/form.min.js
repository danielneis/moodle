define(["jquery","core/str","core/notification","core/ajax","core/templates","core/sortable_list"],function(a,b,c,d,e,f){var g=function(f,g,h,i,j){b.get_strings([{key:"delete"},{key:"confirmdelete",component:"core_customfield"},{key:"yes"},{key:"no"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){switch(g){case"field":var b="core_customfield_delete_entry";break;case"category":var b="core_customfield_delete_category"}var k=d.call([{methodname:b,args:{id:f}},{methodname:"core_customfield_reload_template",args:{component:h,area:i,itemid:j}}]);k[1].done(function(b){e.render("core_customfield/customfield",b).done(function(b,c){a('[data-region="list-page"]').replaceWith(b),e.runTemplateJS(c)}).fail(c.exception)}).fail(c.exception)})}).fail(c.exception)},h=function(b,f,g){var h,i=d.call([{methodname:"core_customfield_create_category",args:{component:b,area:f,itemid:g}},{methodname:"core_customfield_reload_template",args:{component:b,area:f,itemid:g}}]);i[0].then(function(a){h=a})["catch"](c.exception),i[1].then(function(b){e.render("core_customfield/customfield",b).then(function(b,c){a('[data-region="list-page"]').replaceWith(b),e.runTemplateJS(c),window.location.href="#category-"+h})["catch"](c.exception)})["catch"](c.exception)};return{init:function(){var e=a("#customfield_catlist").attr("data-component"),i=a("#customfield_catlist").attr("data-area"),j=a("#customfield_catlist").attr("data-itemid");a("[data-role=deletefield]").on("click",function(b){g(a(this).attr("data-id"),"field",e,i,j),b.preventDefault()}),a("[data-role=deletecategory]").on("click",function(b){g(a(this).attr("data-id"),"category",e,i,j),b.preventDefault()}),a("[data-role=addnewcategory]").on("click",function(){h(e,i,j)});var k=function(a){return a.closest("[data-category-id]").find("[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]").attr("data-value")},l=new f("#customfield_catlist",{moveHandlerSelector:".movecategory [data-drag-type=move]"});l.getElementName=function(b){return a.Deferred().resolve(k(b))},a("[data-category-id]").on("sortablelist-drop sortablelist-dragstart sortablelist-drag sortablelist-dragend",function(a,c){if("sortablelist-drop"==a.type&&c.positionChanged){var e=d.call([{methodname:"core_customfield_move_category",args:{from:c.element.data("category-id"),to:c.targetNextElement.data("category-id")||0}}]);e[0].fail(function(){require(["core/notification"],function(a){b.get_string("errorreloadpage","core_customfield").done(function(b){a.addNotification({message:b,type:"problem"})})})})}a.stopPropagation()});var m=new f("#customfield_catlist .fieldslist tbody",{moveHandlerSelector:".movefield [data-drag-type=move]"});m.getDestinationName=function(c,d){return d.length?d.attr("data-field-name")?b.get_string("afterfield","customfield",d.attr("data-field-name")):a.Deferred().resolve(""):b.get_string("totopofcategory","customfield",k(c))},a("[data-field-name]").on("sortablelist-drop sortablelist-dragstart sortablelist-drag sortablelist-dragend",function(e,f){if("sortablelist-drop"===e.type&&f.positionChanged){var g=d.call([{methodname:"core_customfield_drag_and_drop",args:{from:f.element.data("field-id"),to:f.targetNextElement.data("field-id")||0,category:Number(f.targetList.closest("[data-category-id]").attr("data-category-id"))}}]);g[0].fail(function(){require(["core/notification"],function(a){b.get_string("errorreloadpage","core_customfield").done(function(b){a.addNotification({message:b,type:"problem"})})})})}e.stopPropagation(),b.get_string("therearenofields","core_customfield").then(function(b){a("#customfield_catlist").children().each(function(){a(this).find(a(".field")).length||a(this).find(a(".nofields")).length||a(this).find("tbody").append('<tr class="nofields"><td colspan="5">'+b+"</td></tr>"),a(this).find(a(".field")).length&&a(this).find(a(".nofields")).length&&a(this).find(a(".nofields")).remove()})}).fail(c.exception)}),a("[data-category-id], [data-field-name]").on("sortablelist-dragstart",function(b,c){setTimeout(function(){a(".sortable-list-is-dragged").width(c.element.width())},501)})}}});